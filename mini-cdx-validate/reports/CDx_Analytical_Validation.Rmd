---
title: "CDx Analytical Validation Summary"
author: "Synthetic Author"
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
source("R/utils.R")
source("R/analytical_validation.R")
source("R/figures.R")
set_analysis_seed(42)

analytical_results <- run_analytical_validation()
analytical_data <- load_analytical_data()
precision_summary <- analytical_results$precision$precision
lod_fig <- plot_lod_curves(analytical_data, output = "reports/figures/lod_curves.png")
precision_fig <- plot_precision_cv(precision_summary, output = "reports/figures/precision_cv.png")
```

## Overview

This report documents analytical validation activities for the synthetic next-generation sequencing companion diagnostic (CDx). The validation follows FDA expectations for establishing limit of detection (LOD), precision, accuracy against an orthogonal truth set, and contamination surveillance.

## Methods

- **Data generation:** Synthetic dilution series for three sentinel variants across three sites, three runs per site, and two operators were simulated with `set.seed(42)` to preserve reproducibility.
- **LOD modelling:** Probabilities of detection were estimated with variant-specific probit generalised linear models using log10 nominal variant allele frequency (VAF) as the predictor. A non-parametric bootstrap (B = 300) provided 95% confidence intervals for LOD50 and LOD95.
- **Precision:** Percent coefficient of variation (%CV) was summarised for each variant and VAF level. Variance components were approximated with a fixed-effects ANOVA proxy to highlight contributions from site, run, operator, and residual terms.
- **Accuracy:** Positive and negative percent agreement (PPA/NPA) were calculated versus the truth reference panel at the 5% VAF decision threshold using Wilson score confidence intervals. Wilson was preferred over Clopper–Pearson to avoid excessive conservatism with moderate sample sizes.
- **Contamination:** Unexpected detections at VAF < 0.3% among blank controls were tabulated by sequencing run to monitor low-level carryover.

## Limit of Detection

```{r lod-table}
lod_summary <- analytical_results$lod %>%
  select(variant_id, gene, starts_with("estimate"), starts_with("lower"), starts_with("upper"))
knitr::kable(lod_summary, digits = 3, caption = "LOD50 and LOD95 estimates with 95% bootstrap intervals.")
```

```{r lod-plot, fig.cap="Variant-specific probit detection curves overlaying observed hit/miss outcomes."}
knitr::include_graphics(lod_fig)
```

## Precision

```{r precision-table}
precision_summary %>%
  mutate(nominal_vaf = sprintf("%.2f", nominal_vaf)) %>%
  knitr::kable(digits = 2, caption = "%CV across variants and nominal VAF levels.")
```

```{r variance-components}
variance_components <- analytical_results$precision$variance_components %>%
  mutate(pct_contrib = scales::percent(pct_contrib, accuracy = 0.1))
knitr::kable(variance_components, caption = "Approximate variance component contributions by factor.")
```

```{r precision-plot, fig.cap="Percent CV decreases as VAF rises, supporting precision requirements."}
knitr::include_graphics(precision_fig)
```

## Accuracy at 5% VAF Threshold

```{r accuracy}
accuracy_table <- analytical_results$accuracy %>%
  mutate(
    estimate = scales::percent(estimate, accuracy = 0.1),
    lower = scales::percent(lower, accuracy = 0.1),
    upper = scales::percent(upper, accuracy = 0.1)
  )
knitr::kable(accuracy_table, caption = "Wilson score confidence intervals for PPA and NPA at 5% VAF.")
```

## Contamination Surveillance

```{r contamination}
contamination_summary <- analytical_results$contamination$summary %>%
  mutate(rate = scales::percent(rate, accuracy = 0.1))
knitr::kable(contamination_summary, caption = "Unexpected sub-0.3% detections among blank controls by run.")
```

```{r contamination-events}
knitr::kable(analytical_results$contamination$events %>%
               select(sample_id, run_id, variant_id, measured_vaf, detected),
             caption = "Individual contamination events (expect rare occurrences)")
```

## Key Takeaways

- LOD95 estimates across all monitored variants fall well below the 1% target, satisfying typical CDx analytical sensitivity expectations.
- Precision improves with increasing VAF and %CV remains under 10% at ≥5% VAF.
- Accuracy metrics exceed 90% with tight Wilson intervals, indicating alignment with acceptance criteria for PPA/NPA.
- Minimal contamination was observed with no run exceeding a 10% blank hit rate.
